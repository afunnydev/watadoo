# Watadoo

This backend is a GraphQL server to help manage our events creation, update and automation.

## Setup

You need to add a .env file in the root with the appropriate environment variables:

```
touch .env
```

And then add to the .env file:

```
PRISMA_SECRET="AskFelixForTheSecret"
PRISMA_ENDPOINT="https://prisma.watadoo.ca/watadoo-digitalocean/dev"
SECRET_KEY="AskFelixForTheSecret"
```
## Commands

### Start the server

```go run ./cmd/server```

### Scrape websites

Please note that the scraper uses a cache in the ```/cache``` folder. You can run the command as many time as you want, but once a URL is crawled, it will be pulled from cache. If you want to scrape new events, please delete every folder in the ```/cache```.

```
go run ./cmd/automation

// To save the results in a JSON file
go run ./cmd/automation -json

// To save the results to the DB
go run ./cmd/automation -save
```

### Organize the database

This commands manage occurrences and flags duplicate for you.

```go run ./cmd/organize```

## Deployment

This project is deployed on Heroku. You should use:

```
git subtree push --prefix watadoo-backend heroku-backend master
```

## Modifications to the data model

The data model is in an external folder and needs to be modified there. Once you're satisfied, deploy your new model to prisma and the ORM will be generated automatically in the ```generated``` folder. Please make sure you adjust the ```schema.graphql``` file accordingly. If you added new types (or inputs), you need to add them to the ```gqlgen.yml``` file so that they won't be generated by gqlgn. The type is already declared with the generated prisma files.

### Generate new resolvers

If you make a modification to the data model or added a new mutation/query, you can generate the boilerplate to write the resolvers by running ```go generate ./...```. Please make sure that ```internal/resolvers/tmp``` is deleted prior to running this command. The new ```resolver.go``` file will be generated in there. You can then copy paste the needed resolver and modify it.

### Limitations