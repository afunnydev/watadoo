# Messenger Bot Backend

This project uses Node JS for the Messenger Bot backend.

## Setup

The setup is a bit complicated for the bot, since it needs to be linked to a FB app, that's linked to a FB page. And you need access to both of them. For development, we use the "Watadoo Development" page and a copy of the Watadoo FB app. Anyways, follow along and ask question :)

1) Install dependencies

```
npm install
```

2) Create your local environment file

```
cp .env.example.local .env.development.local
```

The resulting file contains 4 variables already set for you: NODE_ENV, PRISMA_SECRET, PRISMA_ENDPOINT, FRONTEND_URL. You shouldn't change in of these. Please make sure you already followed the setup process in the ```prisma``` folder. All the following steps are related to other variables in this file.

3) Get your PAGE_ACCESS_TOKEN

The PAGE_ACCESS_TOKEN gives you access to anything like you were the page. You should ask Felix for access to the Watadoo Development Facebook Page (it's not public) and the FB app. You can then ask Felix's for the PAGE_ACCESS_TOKEN and the FACEBOOK_VERIFY_TOKEN. You can also grab the FACEBOOK_APP_SECRET directly from the page.

4) Get your GOOGLE_APPLICATION_CREDENTIALS

The GOOGLE_APPLICATION_CREDENTIALS gives you the ability to query our Dialogflow agent and understand the intents of the users. You need access to the Google Cloud Console, and can download it from there. You should put the **full** path to this file in this variable.

5) Uptime bot (not needed for local)

## Project History

At first, we were using the Dialogflow/Messenger integration to fullfill our messages to the user. However, because we needed a billingual bot and more control over the interaction (Dialogflow was still limited), we switched to a custom integration. I didn't have enough experience with a Messenger/Dialogflow integration to craft something perfect on the first take, so this is the best architecture I could come up with.

## Project Architecture

Every folder are pretty much self explanatory. However, some little clarifications:

- ```src/generated```: All files are generated by Prisma. Shouldn't be changed manually
- ```src/resolvers```: This is to resolve the event-landing-page backend queries and mutations.
- ```src/integrations```: This contains the needed information to change the appearance of our Facebook Page in Messenger (persistent menu, welcome screen, get started button)

### Adding a new intent

To add a new intent, follow these steps:

1) Create your intention in Dialogflow. Please add as many training phrases as possible. Start with one language only.
2) Create a new file in ```src/intents```. Please name the file following the camel case convention with the name of the intent, e.g "Notifications - frequency" becomes "notificationsFrequency.js".
3) Add the function to ```src/intents/index.js```.
4) Import the function in ```src/processMessage.js``` and add the intent in the switch statement for detection. Please note that you should passe any relevant context or parameters :)